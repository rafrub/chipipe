# chipipe

Authors: Laura Garrido Andrade, Clara Granado Beltrán and Rafael Rubio Ramos

chipipe is a package that allows ChIP-Seq data analysis for Arabidopsis thaliana. The parameters for the main script of the package, chipipe.sh, must be specified in a .txt file. 

### Usage

```
chipipe.sh <params_file>
```

A model input file can be found in test/test_params.txt. It contains the following parameters:

- installation_directory - the directory where the package is installed; e.g. /home/bag2/scripts
- working_directory - the directory where you wish to save analysis results; e.g. /home/bag2/tarea2
- experiment_name - the package will use this as the name for the generated folder; e.g. prr5_test
- number_replicas - the number of replicas in your study; e.g. 2
- path_genome - the path to the genome of the organism used in your study; e.g. /home/bag2/genomes/arabidopsis.fa
- path_annotation - the path to the annotations of the organism in your study; e.g. /home/bag2/annotations/arabidopsis.gtf
- path_sample_chip_i - (where i is a natural number) the path to the ChIP-Seq data of sample number i.; e.g. home/bag2/prr5_test/sample_chip_1.fq.gz (for paired end files, both paths must be in the same row and separated by a space)
- path_sample_input_1 - (where i is a natural number) the path to the input data of sample number i.; e.g. home/bag2/prr5_test/sample_input_1.fq.gz (for paired end files, both paths must be in the same row and separated by a space)
- universe_chromosomes - the ID(s) of the chromosomes(s) you wish to use as your genetic universe for terms enrichment, separated by commas without spaces; e.g. 2,3. For all available chromosomes, write “all”.
- type_of_peak - “1” for narrow peaks (transcription factor binding) or “2” for broad peaks (histone modifications)
- single_or_paired - “1” for single end reads or “2” for paired end reads
- tss_upstream - number (positive) of pb upstream that the analysis will consider as TSS
- tss_downstream - number (positive) of pb downstream that the analysis will consider as TSS

### Analysis workflow

Following is a list of the actions chipipe.sh takes when executed:
-   Load parameters
-   Generation of workspace
-   Creation of the reference genome index (bowtie2-build)
-   Processing samples.
The last part is performed by a support script named sample_proc. The script carries out these following steps for every replica:
-   Load parameters
-   Quality control (fastqc)
-   Mapping to the reference genome (bowtie2)
-   Conversion of sam into sorted bam (samtools)
-   Peak calling (macs2 callpeak)
Once all the replicas are finished, the next script is peak_call
-   Intersection of all the replicas (bedtools)
-   Finding motifs (findMotifsGenome.pl) You can visit [HOMER's website](http://homer.ucsd.edu/homer/motif/) for further details


The statistical visualization is performed in R with another script:
-   Definition of parameters
-   Reading of peak file (ChIPseeker)
-   Definition of promoter regions (ChIPseeker)
-   Calculation of the peak distribution along the genome
-   Annotation of peaks according to the types of DNA regions they bind to
-   Saving peaks that bind to promoter regions
-   Listing genes affected by the TF (its regulome)
-   Defining universe for GO & KEGG terms enrichment.
-   Listing genes affected by the TF (its regulome)
-   GO terms enrichment BP, CC, MF
-   KEGG terms enrichment

### Output description

As for the output, the chipipe package creates a directory in which the resulting files are included in different subdirectories as it follows:

- genome: contains the reference genome used for the analysis and its index.
 
- annotation: contains the reference annotation used for the analysis.
 
- samples: includes several directories, one for each replica. Each one of these are divided into three other folders: chip, input and replica_results. The chip and input directories contain the sorted bam files for the corresponding sample, the results of fastqc quality analysis for that sample and a stats.txt file with the bowtie2 alignment stats. The replica_results directory includes the peaks files generated by macs2, both narrowPeak and broadPeak.  
 
- results: contains all the results for the analysis. First of all, it contains the merged peaks files of the replicas. These files are generated by iteration and there will be n-1 files for n replicas. If there are errors in one of the replicas (as indicated in the fastqc output or the bowtie2 alignment stats), it is necessary to erase the merged files and use bedtools to intersect the previous merged file with the peak files of the rest of the replicas and execute the R script. If no errors are detected, analysis will be performed with the last merged file (higher number). This folder also includes the motifs by HOMER. In the Rplots.pdf file, general information can be found about the ChIP-seq analysis such as covplot, plotAnnopie of the distribution of the type of DNA regions which suffer the modification or the plotDistToTSS (distribution of peaks around TSS regions). Genes predicted to be affected by the TF binding or histone modification are listed in regulome.txt file. As for the GO terms analysis, the GO terms enrichment for Biological Processes (BP), Molecular Functions (MF) and Cellular Components (CC) are obtained. The information about the GO terms is saved as tables in tsv format, as well as in plots that are represented in a pdf file for each one of the three categories (goplots, barplots, dotplots and cnetplots). Finally, KEGG pathways enrichment information is saved as a table in a tsv file, and the aforementioned pathways are shown as png files in this directory, while the xml and png (without marked enzymes) files are collected in kegg_images directory.
